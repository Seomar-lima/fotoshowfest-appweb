<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foto Show Fest</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
  <script src="https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js"></script>
</head>
<body>
  <!-- Elementos HTML (mantenha os existentes) -->
  <div id="statusUpload"></div>
  <div id="qrDownload"></div>
  <video id="camera" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    // ========== [CORREÇÃO 1/5] DECLARAÇÃO DE VARIÁVEIS AUSENTES ==========
    const statusUpload = document.getElementById("statusUpload");
    const qrDiv = document.getElementById("qrDownload");
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    let mediaRecorder;
    let chunks = [];

    // ========== [CORREÇÃO 2/5] INICIALIZAÇÃO CORRETA DO FFMPEG ==========
    const { createFFmpeg } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });
    let ffmpegLoaded = false;

    // ========== [CORREÇÃO 3/5] FUNÇÃO SCROLLTOLEMENT AUSENTE ==========
    function scrollToElement(element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ========== [CORREÇÃO 4/5] FUNÇÃO BAIXARIMAGEM AUSENTE ==========
    function baixarImagem(dataUrl) {
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = `foto_showfest_${Date.now()}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Configurações do Bumerangue
    const BOOMERANG_SETTINGS = { 
      width: 540, 
      height: 960, 
      fps: 30, 
      duration: 2 
    };

    // ========== FUNÇÕES PRINCIPAIS ==========
    async function initFFmpeg() {
      if (!ffmpegLoaded) {
        statusUpload.innerText = "Carregando conversor de vídeo...";
        statusUpload.style.display = "block";
        await ffmpeg.load();
        ffmpegLoaded = true;
        statusUpload.style.display = "none";
      }
    }

    async function convertToMP4(webmBlob) {
      await initFFmpeg();
      const inputName = 'input.webm';
      const outputName = 'output.mp4';

      ffmpeg.FS('writeFile', inputName, new Uint8Array(await webmBlob.arrayBuffer()));
      
      await ffmpeg.run(
        '-i', inputName,
        '-c:v', 'libx264',
        '-profile:v', 'baseline',
        '-pix_fmt', 'yuv420p',
        '-movflags', '+faststart',
        outputName
      );

      const data = ffmpeg.FS('readFile', outputName);
      return new Blob([data.buffer], { type: 'video/mp4' });
    }

    async function uploadToGoFile(blob, type) {
      statusUpload.innerText = `Enviando ${type}...`;
      statusUpload.style.display = "block";

      try {
        const extension = type === 'video' ? 'mp4' : 'png';
        const formData = new FormData();
        formData.append('file', blob, `showfest_${Date.now()}.${extension}`);

        const serverRes = await fetch('https://api.gofile.io/getServer');
        const { data: { server } } = await serverRes.json();

        const uploadRes = await fetch(`https://${server}.gofile.io/uploadFile`, {
          method: 'POST',
          body: formData
        });

        const { data } = await uploadRes.json();
        return data.downloadPage;

      } finally {
        statusUpload.style.display = "none";
      }
    }

    // ========== [CORREÇÃO 5/5] INICIALIZAÇÃO CORRETA DO MEDIARECORDER ==========
    function iniciarGravacaoBumerangue() {
      chunks = [];
      const canvasVideo = document.createElement('canvas');
      canvasVideo.width = BOOMERANG_SETTINGS.width;
      canvasVideo.height = BOOMERANG_SETTINGS.height;
      const stream = canvasVideo.captureStream(BOOMERANG_SETTINGS.fps);
      
      mediaRecorder = new MediaRecorder(stream, { 
        mimeType: 'video/webm;codecs=vp9' 
      });

      mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
      mediaRecorder.onstop = () => processBoomerang(chunks);
      mediaRecorder.start();
    }

    async function processBoomerang(chunks) {
      try {
        const webmBlob = new Blob(chunks, { type: 'video/webm' });
        statusUpload.innerText = "Convertendo para MP4...";
        statusUpload.style.display = "block";
        
        const mp4Blob = await convertToMP4(webmBlob);
        const downloadUrl = await uploadToGoFile(mp4Blob, 'video');
        gerarQRCode(downloadUrl);

      } catch (error) {
        console.error("Erro:", error);
        qrDiv.innerHTML = `<p style="color:red">Erro ao processar vídeo</p>`;
      }
    }

    async function processPhoto(imgData) {
      const blob = dataURLtoBlob(imgData);
      const downloadUrl = await uploadToGoFile(blob, 'image');
      gerarQRCode(downloadUrl);
      baixarImagem(imgData);
    }

    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], { type: mime });
    }

    function gerarQRCode(link) {
      qrDiv.innerHTML = `
        <h3 style="color:#FFD700;text-align:center">Escaneie para baixar</h3>
        <div id="qrcode" style="margin:0 auto"></div>
        <a href="${link}" style="color:#FFD700;display:block;margin-top:10px" target="_blank">
          Link direto
        </a>
      `;
      new QRCode(document.getElementById("qrcode"), {
        text: link,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff"
      });
      scrollToElement(qrDiv);
    }

    // Inicialização da câmera
    navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1920 }, height: { ideal: 1080 }, facingMode: 'user' },
      audio: false
    }).then(stream => {
      video.srcObject = stream;
    }).catch(err => {
      console.error("Erro na câmera:", err);
    });
  </script>
</body>
</html>
